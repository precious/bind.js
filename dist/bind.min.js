var Bind=function(e){"use strict";function t(e){return(e+"").replace(/[<>]/g,function(e){return{">":"&gt;","<":"&lt;"}[e]})}function n(e,t){for(var n=e.length,r=0;r<n;r++)t(e[r],r,e)}function r(e,t){n("pop push reverse shift sort splice unshift".split(" "),function(n){this[n]=function(){this.__dirty=!0;var r=a({},s[n].apply(this,arguments));return delete this.__dirty,e&&t.ready&&e(this),r}.bind(this)}.bind(this)),this.replaceWith=function(e){this.splice.apply(this,[0,this.length].concat(e))};var r=this.length;return Object.defineProperty(this,"length",{configurable:!1,enumerable:!0,set:function(e){if(this.__dirty)return void(r=e);var t=1*e;return r!==t&&(t>r?this.push.apply(this,new Array(t-r)):this.splice(t),r=t),e},get:function(){return r}}),this}function i(e,c,s,p){return p||(p=[]),s.ready&&c.__callback?e:(n(Object.getOwnPropertyNames(c),function(y){if("__callback"!==y){var v,b=c[y],g=[].slice.call(p),_=function(e){return t(e)},m=h,k=!1;g.push(y);var A=s.mapping[g.join(".")];if(A&&"[object Object]"===A.toString()&&(A.callback&&(v=A.callback),A.transform&&(_=d(A.transform.bind({safe:t}))),A.parse&&(m=d(A.parse)),A.mirror&&(k=A.mirror),A=A.dom),"function"==typeof A)v=A;else if("string"==typeof A){var E=o(A||"☺");0===E.length&&console.warn('No elements found against "'+A+'" selector');var O=["SELECT","INPUT","PROGRESS","TEXTAREA"],N=["password","text","search","email","url","tel","number"];if(null===b||void 0===b)if(-1!==O.indexOf(E[0].nodeName))if("checkbox"===E[0].type){b=[];for(var T=0,j=E.length;T<j;T++)E[T].checked&&b.push(m(E[T].value))}else b=m(E[0].value);else b=m(E[0].innerHTML);var S=v;v=function(t){E=o(A||"☺"),E&&n(E,function(e){if(!e.__dirty)if(-1!==O.indexOf(e.nodeName)){var r=_(t);if("checkbox"===e.type){if(t instanceof Array){var i=t.filter(function(t){if(t===e.value)return e.checked=e.value===t,!0});0===i.length&&(e.checked=!1)}}else"radio"===e.type?e.checked=e.value===r:e.value=r}else{t instanceof Array||(t=[t]);var a="";n(t,function(e){a+=_(e)}),e.innerHTML=a}}),S&&S.apply(e,arguments)},n(E,function(t){if("INPUT"===t.nodeName||"SELECT"===t.nodeName||"TEXTAREA"===t.nodeName){var r=function(){this.__dirty=!0;var r;if("checkbox"===t.type){var i=(t.form||document).querySelectorAll('input[name="'+t.name+'"][type="'+t.type+'"]');if(e[y]instanceof Array){var a=[];n(i,function(e){e.checked&&a.push(m(e.value))}),r=a}else r=this.checked?m(this.value):null}else r="radio"===t.type?this.checked?m(this.value):null:m(this.value);if(void 0===r&&(r=this.value),e[y]=r,k&&("TEXTAREA"===t.nodeName||"INPUT"===t.nodeName&&-1!==N.indexOf(t.type))&&"string"==typeof r&&this.value!==r){var c=this,o=this.selectionStart-(this.value.length-r.length),l=document.activeElement===this&&this.selectionStart==this.selectionEnd;this.value=r,l&&setTimeout(function(){c.setSelectionRange(o,o)},0)}this.__dirty=!1},i={checkbox:"change",radio:"change","select-one":"change","select-multiple":"change"}[t.type];t.addEventListener(i||"input",r)}})}v&&g.reduce(function(e,t,n,r){return e[t]||(e[t]={}),n===r.length-1&&(e[t].__callback=v),e[t]},s.callbacks);var x=function(e){var t=[],n=[],r=s.instance,i=!1,c=!1;if(l&&console.log("> finding callback for %s",y,g),g.reduce(function(o,l,s){if(o&&o[l]&&l){if(null===(r=r[l])||void 0===r)return o[l]||{};if("function"==typeof o[l].__callback){var u=s===g.length-1?e:r;r.__dirty&&(i=!0),s===g.length-1&&o[l].__callback&&(c={path:g.join("."),callback:o[l].__callback,instance:u}),i||(n.push(a(u instanceof Array?[]:{},u)),t.push(o[l].__callback))}return o[l]||{}}},s.callbacks),i||(n.reverse(),t.reverse().forEach(function(e,t){e.call(s.instance,n[t])})),i&&c){var r=c.instance;c.callback.call(s.instance,a(r instanceof Array?[]:{},r))}},P={configurable:!0,enumerable:!0,set:function(t){var n=b!==t?b:void 0;b=!s.ready||typeof t!==f||null===t||u(t)||t.__callback?u(t)?i(new r(x,s),t,s,g):t:i(e[y]?a({},e[y]):{},t,s,g),l&&console.log("set: key(%s): %s -> %s",y,JSON.stringify(n),JSON.stringify(t)),s.ready?x(b):s.deferred.push(x.bind(e,b,n))},get:function(){return b}};try{Object.defineProperty(e,y,P)}catch(e){}typeof b!==f||null===b||u(b)?u(b)?e[y]=i(new r(x,s),b,s,g):e instanceof r||(e[y]=b):e[y]=i(e[y]||{},b,s,g)}}),e instanceof r&&e.push.apply(e,c),e)}function a(e,t){return t instanceof Object?(n(Object.getOwnPropertyNames(t),function(n){var r=t[n];c.prototype[n]||"__callback"===n||(typeof r===f&&null!==r&&r instanceof Array?e[n]=[].map.call(r,function(t){return t instanceof Object?a(e[n]||{},t):t}):typeof r!==f||null===r||u(r)?e[n]=r:e[n]=a(e[n]||{},r))}),e):t}function c(t,r){if(!this||this===e)return new c(t,r);var a={mapping:r||{},callbacks:{},deferred:[],ready:!1,instance:this};return i(this,t,a),a.ready=!0,a.deferred.length&&n(a.deferred,function(e){e()}),this}if(!Function.bind||!Object.defineProperty)throw new Error("Prerequisite APIs not available.");var o,l=!1;try{o=document.querySelectorAll.bind(document)}catch(e){}var s=[],u=Array.isArray,f="object",h=function(e){return e},d=function(e){return function(){try{return e.apply(this,arguments)}catch(e){console.error(e.stack?e.stack:e)}}};return r.prototype=[],c.prototype.__export=function(){return a({},this)},c}(this);"undefined"!=typeof exports&&(module.exports=Bind);
